# The transformation query specified here will be used to change each exported 
# message into a different format. You can get started using the example below,
# and learn more about the language in documentation:
# https://aka.ms/dataexporttransformation
import "iotc" as iotc;
{
    applicationId: .applicationId,
    parent: .device.id | gsub("_";"-"),
    parentModel: (.device.templateId // "dtmi:com:microsoft:iot:e2e:digital_factory:production_line;1"),
    parentChildRel: "rel_runs_steps",
    id:.telemetry[] | select(.name=="name").value | gsub("_";"-"),
    raw_id:.telemetry[] | select(.name=="nodeid").value,
    model: "dtmi:com:microsoft:iot:e2e:digital_factory:production_step_moulding;1",
    messageSource: .messageSource,
    properties: {
    StartTime: .telemetry | iotc::find(.name=="source_time_stamp").value | strptime("%m/%d/%Y, %H:%M:%S") | todate,
    StepId: .telemetry[] | select(.name=="nodeid").value
    },
    telemetry:.telemetry[]| select(.name=="value").value,
    component: .component
}